<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><title>Statistiche RPE</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-4xl mx-auto bg-white p-6 rounded shadow">
    <div class="flex justify-between mb-6">
      <h1 class="text-2xl font-bold">Statistiche Allenamenti</h1>
      <a href="index.html" class="text-blue-600 hover:underline">‚Üê Inserimento</a>
    </div>
    <div id="loader" class="flex justify-center py-4">
      <svg class="animate-spin h-6 w-6 text-blue-500" xmlns="..."><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"/></svg>
    </div>
    <div id="charts" class="hidden space-y-8">
      <canvas id="chartRPE"></canvas>
      <canvas id="chartDurata"></canvas>
    </div>
  </div>
<script>
const API = 'https://script.google.com/macros/library/d/10zbobOt9lQNeFxgU6UYr7a3ZDJvur6iZ4lfqrevTwla5LFy9gvRc5if1/1';
Promise.all([
  fetch(`${API}?action=get_metadata`).then(r=>r.json()),
  fetch(`${API}?action=get_stats`).then(r=>r.json())
]).then(([meta, stats]) => {
  const mAt = Object.fromEntries(meta.atlete.map(a=>[a[0], `${a[1]} ${a[2]}`]));
  const ruol = Object.fromEntries(meta.atlete.map(a=>[a[0], a[5]]));
  const durPerRuolo={}, rpePerAtleta={};

  stats.rpe_join.forEach(r=>{
    const idA = r[1], idAl = r[2], idR = r[3];
    const dur = stats.allenamenti.find(a=>a[0]==idAl)?.[2] || 0;
    rpePerAtleta[idA] = (rpePerAtleta[idA]||0) + parseInt(meta.rpe.find(rr=>rr[0]==idR)[1]);
    durPerRuolo[ruol[idA]] = (durPerRuolo[ruol[idA]]||0) + parseInt(dur);
  });

  document.getElementById("loader").classList.add("hidden");
  document.getElementById("charts").classList.remove("hidden");

  new Chart(document.getElementById('chartRPE'), {
    type: 'bar',
    data: { labels: Object.keys(rpePerAtleta).map(k=>mAt[k]), datasets:[{label:'RPE Totale',data:Object.values(rpePerAtleta),backgroundColor:'#60a5fa'}] },
    options:{responsive:true}
  });
  new Chart(document.getElementById('chartDurata'), {
    type:'pie',
    data:{ labels:Object.keys(durPerRuolo), datasets:[{data:Object.values(durPerRuolo),
      backgroundColor:['#3b82f6','#34d399','#f59e0b','#ef4444']}]
    },
    options:{responsive:true}
  });
});
</script>
</body>
</html>
