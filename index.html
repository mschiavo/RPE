<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><title>Registro RPE</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <div class="max-w-3xl mx-auto bg-white p-6 rounded shadow">
    <div class="flex justify-between mb-6">
      <h1 class="text-2xl font-bold">Registro RPE</h1>
      <a href="stats.html" class="text-blue-600 hover:underline">Statistiche</a>
    </div>
    <label class="block mb-2">Durata (min):</label>
    <input type="number" id="durata" class="w-full p-2 border rounded mb-4">

    <div id="loader" class="hidden justify-center py-4">
      <svg class="animate-spin h-6 w-6 text-blue-500" xmlns="..."><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8H4z"/></svg>
      <span class="ml-2 text-blue-600">Caricamentoâ€¦</span>
    </div>

    <div id="listaAtlete" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
    <button onclick="inviaDati()" class="w-full bg-blue-600 text-white p-2 mt-4 rounded hover:bg-blue-700">Salva</button>
  </div>

<script>
const API = 'https://script.google.com/macros/library/d/10zbobOt9lQNeFxgU6UYr7a3ZDJvur6iZ4lfqrevTwla5LFy9gvRc5if1/1';
if (!localStorage.getItem("rpe_user_email")) location='login.html';

async function loadMeta() {
  const c = sessionStorage.getItem("meta");
  if (c) return JSON.parse(c);

  const res = await fetch(`${API}?action=get_metadata`);
  const json = await res.json();
  sessionStorage.setItem("meta", JSON.stringify(json));
  return json;
}

document.getElementById("loader").classList.remove("hidden");
loadMeta().then(data => {
  const d = document.getElementById("listaAtlete");
  data.atlete.forEach(a => {
    const card = document.createElement('div');
    card.className = 'bg-gray-50 p-4 rounded';
    card.innerHTML = `<strong>${a[1]} ${a[2]}</strong><select data-id="${a[0]}" class="w-full mt-2 border rounded p-1">${data.rpe.map(r=>`<option value="${r[0]}">${r[1]} - ${r[2]}</option>`).join('')}</select>`;
    d.appendChild(card);
  });
}).finally(_=>document.getElementById("loader").classList.add("hidden"));

async function inviaDati() {
  const durata = document.getElementById("durata").value;
  if (!durata || durata <= 0) return alert("Durata non valida");
  const data = new Date().toISOString().split('T')[0];
  const regs = [...document.querySelectorAll('select')].map(s=>({ id_atleta:s.dataset.id, id_rpe:s.value }));

  document.getElementById("loader").classList.remove("hidden");
  const res = await fetch(API,{method:'POST',body:JSON.stringify({data, durata, registrazioni:regs})});
  alert(await res.text());
  document.getElementById("loader").classList.add("hidden");
}
</script>
</body>
</html>
